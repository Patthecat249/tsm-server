# Dies ist das erste Play
- name: "Installiere einen Server"
  hosts: tsm
  gather_facts: true
  vars_files: 
    - "../vars/central_vars.yaml"
    - "../../credentials"
  
  tasks:
    - name: "# --- 00 - Disable SELinux"
      # Disable SELinux
      selinux:
        state: disabled
    
    - name: "# --- 01 - Register tsm-server with RHSM"
      redhat_subscription:
        state: present
        username: "{{ redhat_user }}"
        password: "{{ redhat_pass }}"
        #environment: Library
        autosubscribe: yes

    - name: "# --- 02 - Install prerequisites and software necessary programs"
      yum: 
        name: "nfs-utils.x86_64"
        state: "present"

    - name: "# --- 02a - Install KSH"
      yum: 
        name: "ksh.x86_64"
        state: "present"

    - name: "# --- 03 - Erstelle Arbeitsverzeichnisse"
      file: 
        path: "{{ item }}"
        #mode: ""
        #owner: ""
        #group: ""
        state: directory
        recurse: true
      with_items:
        - "{{ mount_path_tsm }}"
        - "{{ mount_path_cdrom }}"
        - "{{ dir_work }}{{ dir_tsm }}{{ dir_tsm_extracted_install }}"

# Mounte NFS-Server-Verzeichnis zum Kopieren der Kickstart-Datei
    - name: "# --- 04 - Mounting NFS-Share"
      mount:
        fstype: nfs
        opts: "nfsvers=3,nolock"
        dump: "0"
        passno: "0"
        state: mounted
        src: "{{ nfs_server_name }}:{{ nfs_path }}"
        path: "{{ mount_path_tsm }}"

# Copy BIN-File
    - name: "# --- 05 - Copy BIN-File from NAS to {{ dir_work }}{{ dir_tsm }}{{ dir_tsm_extracted_install }}"
      copy:
        src: "{{ mount_path_tsm }}{{ nfs_path_bin_file }}"
        dest: "{{ dir_work }}{{ dir_tsm }}{{ dir_tsm_extracted_install }}{{ bin_file_name }}"
        mode: "0755"
        remote_src: yes

# Extract the BIN-File
    - name: "# --- 06 - Extract BIN-File"
      shell: "cd {{ dir_work }}{{ dir_tsm }}{{ dir_tsm_extracted_install }} && {{ dir_work }}{{ dir_tsm }}{{ dir_tsm_extracted_install }}{{ bin_file_name }}"

# Disable SELINUX

# Create Group
    - name: "# --- 07 - Create group 1111"
      group:
        name: "tsmsrvs"
        gid: "1111"
        state: present

# Erstelle den TSM-User
    - name: "# --- 08 - Erstelle den TSM-User {{ tsm_username }}"
      user:
        name: "{{ tsm_username }}"
        comment: "Dies ist der TSM-Installationsbenutzer"
        uid: "2222"
        group: "1111"
    

  
